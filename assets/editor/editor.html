<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Monaco Editor</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com file: data:;">
    <style>
        html, body, #container {
            height: 100%; margin: 0; padding: 0; overflow: hidden; background: transparent;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    </style>
    <script>
      // This placeholder will be replaced by Dart code with the actual path to the 'vs' directory.
      const VS_PATH = "__VS_PATH__"; 
      window.require = { paths: { 'vs': VS_PATH } };
    </script>
</head>
<body>
    <div id="container"></div>
    <script>
      function bootEditor() {
        require(['vs/editor/editor.main'], function() {
            const prefersDarkTheme = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            window.editor = monaco.editor.create(document.getElementById('container'), {
                value: '// Loading content...',
                language: 'plaintext',
                theme: prefersDarkTheme ? 'vs-dark' : 'vs', // Adjusted to use 'vs' for light theme as per standard Monaco themes
                fontSize: 13, // Default, will be overridden by widget.fontSize
                wordWrap: 'off', // Default, will be overridden by widget.wordWrap
                minimap: { enabled: false },
                automaticLayout: true,
                fontFamily: 'JetBrains Mono, SF Mono, Monaco, Inconsolata, Fira Code, monospace',
                lineNumbers: 'on', // Default, will be overridden by widget.showLineNumbers
                renderWhitespace: 'selection',
                scrollBeyondLastLine: false,
                smoothScrolling: true,
                cursorBlinking: 'smooth',
                cursorSmoothCaretAnimation: true,
                padding: { top: 10, bottom: 10 },
                readOnly: true // Default, will be overridden by widget.readOnly
            });

            function notifyFlutter(handler, ...args) {
                const messagePayload = { handler: handler, args: args };
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage(messagePayload);
                } else if (window.flutter_inappwebview) {
                    window.flutter_inappwebview.callHandler(handler, ...args); // callHandler might not take a single object payload like postMessage
                } else {
                    // Fallback for other environments or direct console logging for debugging
                    window.location.href = 'flutter://' + encodeURIComponent(JSON.stringify(messagePayload));
                }
            }

            window.setEditorContent = function(content) { window.editor.setValue(content); };
            window.setEditorOptions = function(options) { window.editor.updateOptions(options); };
            window.setEditorLanguage = function(language) { monaco.editor.setModelLanguage(window.editor.getModel(), language); };
            window.getEditorContent = function() { return window.editor.getValue(); };
            
            window.detectAndSetLanguage = function() { 
                const content = window.editor.getValue();
                let language = 'plaintext';
                // Simple language detection based on content patterns (can be expanded)
                if (content.includes('import \'package:flutter') || (content.includes('class ') && content.includes(' extends '))) {
                    language = 'dart';
                } else if (content.includes('import React') || content.includes('function ') || content.includes('const ')) {
                    language = 'javascript';
                } else if (content.includes('<!DOCTYPE html>') || content.includes('<html')) {
                    language = 'html';
                } else if ((content.includes('def ') && content.includes(':')) || (content.includes('import ') && content.includes(' from '))) {
                    language = 'python';
                } else if (content.trim().startsWith('{') && content.trim().endsWith('}')) {
                    try { JSON.parse(content); language = 'json'; } catch (e) { /* not json */ }
                } else if (content.trim().startsWith('<') && content.trim().endsWith('>')) {
                    language = 'xml'; // A guess, could be HTML too
                }
                monaco.editor.setModelLanguage(window.editor.getModel(), language);
            };
            notifyFlutter('onEditorReady');
        });
      }

      function loadScript(src, onLoad, onError) {
        const script = document.createElement('script');
        script.src = src;
        script.onload = onLoad;
        script.onerror = onError;
        document.head.appendChild(script);
      }

      // Try loading local Monaco loader first. If VS_PATH is not replaced (e.g., "__VS_PATH__"), 
      // it will fail, and then it tries CDN.
      loadScript(VS_PATH + '/loader.js', bootEditor, function() {
          console.warn('Local Monaco loader failed (path: ' + VS_PATH + '/loader.js), trying CDN...');
          loadScript('https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.js', bootEditor, function() {
              console.error("Failed to load Monaco from CDN as well. Editor cannot be initialized.");
              // Optionally, notify Flutter about the complete failure
              // notifyFlutter('onLoadError', 'Failed to load Monaco Editor from all sources.');
          });
      });
    </script>
</body>
</html>